# CoVO-MPC: CoVariance-Optimal MPC

<div align="center">

[[Website]](https://panchaoyi.com/covo-mpc-theoretical-analysis-of-sampling-based-mpc-and-optimal-covariance-design)
[[PDF]](https://drive.google.com/file/d/1u964n8BeQnZhwXpms7hJx8DNDYjwxTxy/view?usp=share_link)

[![Python Version](https://img.shields.io/badge/Python-3.10-blue.svg)](https://github.com/eureka-research/Eureka)
[<img src="https://img.shields.io/badge/Backend-Jax-red.svg"/>](https://github.com/google/jax)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

Simulator             |  Hardware (Crazyflie)
:-------------------------:|:-------------------------:
![output](https://github.com/LeCAR-Lab/CoVO-MPC/assets/60093981/50d11272-3a51-4ed5-b734-bca1b80a9ef5) | ![tracking_compare](https://github.com/LeCAR-Lab/CoVO-MPC/assets/60093981/b835403d-8f78-49e7-8ac7-d3b902429839)

</div>

Implementation of the novel sampling-based Model Predictive Control (MPC) algorithm, **CoVariance-Optimal MPC (CoVO-MPC)**, developed through the research outlined in [the associated paper](https://drive.google.com/file/d/1u964n8BeQnZhwXpms7hJx8DNDYjwxTxy/view?usp=share_link). This new control algorithm is sought to outperform standard Model Predictive Path Integral Control (MPPI) by **43 to 54%**.

## Installation

```shell
conda create -n jax python
conda activate jax
pip install -e .
```

## Run `CoVO-MPC`

Run `CoVO-MPC` in quadrotor environment (if you want to run other controllers, just replace `covo-online` with `pid`, `l1`, `mppi`, `nn`, `RMA` etc. you can also change the task to `tracking` or `hover`): 

```shell
cd quadjax/envs
# note: --noDR means no domain randomization, disable it if running a controller
python quadrotor.py --controller covo-online --task tracking_zigzag --mode render --disturb_type none --noDR 
# run CoVO-MPC offline approximation version
python quadrotor.py --controller covo-offline --task tracking_zigzag --mode render --disturb_type none --noDR 
```

This will generate tested state sequence `state_seq.pkl` and plot figure `plot.png`.

Reproduce the results in the `CoVO-MPC` paper: 

```shell
cd quadjax/scripts
# main results
sh covo_quadrotor.sh
# ablation study for sampling number
sh covo_quadrotor_N.sh
```

## All Supported algorithms

* RL
  * PPO + Auto curriculum + Domain randomization
  * [RMA](https://arxiv.org/abs/2106.00091) (Rapid Motor Adaptation)
  * [DATT](https://arxiv.org/abs/2310.09053) (Deep Adaptive Trajectory Tracking)
* Control
  * PID, L1 Adaptive Control
  * MPPI (model predictive path integral)
  * ðŸŒŸ [CoVO-MPC](https://panchaoyi.com/covo-mpc-theoretical-analysis-of-sampling-based-mpc-and-optimal-covariance-design) (optimal covariance model predictive control)

## Visualization

```shell
cd quadjax/scripts
python vis.py
```

This will visualize the results in `quadjax/results/state_seq_.pkl` with meshcat, which is generated by `quadjax/envs/quadrotor.py`.

## Train policy

Train `PPO`:
```shell
cd quadjax
python train.py
```

Train `RMA`: 
```shell
cd quadjax
python train.py --RMA
```

Train `DATT`: 
```shell
cd quadjax
python train.py --lower-controller l1_esitimate_only --obs-type quad_l1 --disturb-type periodic --task tracking_zigzag
```

Training debug

```
python train.py --env quad3d_free --debug
```

## Notes

* all action in the environment is normalized into [-1, 1] range.
* for easier modification, the environment is designed to be simple single file format.
